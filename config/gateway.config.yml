http:
  port: 8080
admin:
  port: 9876
  host: localhost

apiEndpoints:
  publicRoutes:
    host: localhost
    paths:
      - /users/login
      - /users/register
      - /users/health
      - /users/verify
      - /contactus
  protectedRoutes:
    host: localhost
    paths:
      - /home
      - /users/*/profile
      - /posts/*
      - /messages
      - /users/*

serviceEndpoints:
  userService:
    url: 'http://host.docker.internal:5001'
  historyService:
    url: 'http://host.docker.internal:5003'
  postReplyService:
    url: 'http://host.docker.internal:5004'
  messageService:
    url: 'http://host.docker.internal:5002'
  fileService:
    url: 'http://host.docker.internal:5005'

policies:
  - proxy
  - cors
  - jwt
  - claims-forwarding

pipelines:
  publicPipeline:
    apiEndpoints:
      - publicRoutes
    policies:
      - cors:
          - action:
              origin: '*'
              credentials: true
      - proxy:
          - action:
              serviceEndpoint: userService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/users/(login|register|health|verify)$'
          - action:
              serviceEndpoint: messageService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/contactus$'

  protectedPipeline:
    apiEndpoints:
      - protectedRoutes
    policies:
      - cors:
          - action:
              origin: '*'
              credentials: true
      - jwt:
          - action:
              secretOrPublicKey: ${JWT_SECRET}
              checkCredentialExistence: false
              algorithms:
                - HS256
              issuer: 'forum_user_service'
      - claims-forwarding:
          - action:
      - proxy:
          - action:
              serviceEndpoint: userService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/home$|^/users/.*/profile$|^/users$'
          - action:
              serviceEndpoint: historyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/home$'
          - action:
              serviceEndpoint: postReplyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/posts/.*$'
          - action:
              serviceEndpoint: historyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/posts/.*$'
          - action:
              serviceEndpoint: messageService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/messages$'
