http:
  port: 8080

admin:
  port: 9876
  host: 0.0.0.0   # CHANGED (was localhost)

apiEndpoints:
  publicRoutes:
    host: localhost
    paths:
      - /users/login
      - /users/register
      - /users/health
      - /users/verify
      - /contactus

  # CHANGED: split post routes out so they can skip claims-forwarding
  postRoutes:
    host: localhost
    paths:
      # Keep if any client still calls /posts/*
      - /posts
      - /posts/*

      # âœ… Post service real mounted routes (under /api)
      - /api/posts
      - /api/posts/*
      - /api/replies
      - /api/replies/*
      - /api/me/posts/*
      - /api/admin/posts/*

  # CHANGED: protectedRoutes no longer includes post routes; history uses /history/*
  protectedRoutes:
    host: localhost
    paths:
      - /home
      - /users/*/profile
      - /users/*
      - /messages
      - /history
      - /history/*

serviceEndpoints:
  userService:
    url: 'http://host.docker.internal:5001'
  historyService:
    url: 'http://host.docker.internal:5003'
  postReplyService:
    url: 'http://host.docker.internal:5004'
  messageService:
    url: 'http://host.docker.internal:5002'
  fileService:
    url: 'http://host.docker.internal:5005'

policies:
  - proxy
  - cors
  - jwt
  - claims-forwarding

pipelines:
  publicPipeline:
    apiEndpoints:
      - publicRoutes
    policies:
      - cors:
          - action:
              origin: '*'
              credentials: true

      - proxy:
          - action:
              serviceEndpoint: userService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/users/(login|register|health|verify)$'

          - action:
              serviceEndpoint: messageService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/contactus$'

  # ADDED: post pipeline without claims-forwarding
  postPipeline:
    apiEndpoints:
      - postRoutes
    policies:
      - cors:
          - action:
              origin: '*'
              credentials: true

      - jwt:
          - action:
              secretOrPublicKey: ${JWT_SECRET}
              checkCredentialExistence: false
              algorithms:
                - HS256
              issuer: 'forum_user_service'

      - proxy:
          - action:
              serviceEndpoint: postReplyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/api/(posts|replies|me/posts|admin/posts)(/.*)?$'

          - action:
              serviceEndpoint: postReplyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/posts(/.*)?$'

  protectedPipeline:
    apiEndpoints:
      - protectedRoutes
    policies:
      - cors:
          - action:
              origin: '*'
              credentials: true

      - jwt:
          - action:
              secretOrPublicKey: ${JWT_SECRET}
              checkCredentialExistence: false
              algorithms:
                - HS256
              issuer: 'forum_user_service'

      - claims-forwarding:
          - action: {}

      - proxy:
          # Users + profile + home
          - action:
              serviceEndpoint: userService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/home$|^/users/.*/profile$|^/users$|^/users/.*$'

          # Home history
          - action:
              serviceEndpoint: historyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/home$'

          # History (moved off /posts/*)
          - action:
              serviceEndpoint: historyService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/history(/.*)?$'

          # Messages
          - action:
              serviceEndpoint: messageService
              changeOrigin: true
              prependPath: false
              stripPath: false
              condition:
                name: path
                matchRegex: '^/messages$'
